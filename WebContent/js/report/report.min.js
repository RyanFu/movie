window.Report=function(a){this.param={type:"get",data:{pageSize:100000},dataUrl:"",listUrl:"",dataContainer:".part_table table",listContainer:".sel_wrap1 .pop_menu ul",dataTmpl:"#tmplData",dataPromotionTmpl:"#tmplPromotionData",listTmpl:"#tmplList"};
$.extend(this.param,a);this.period="day_-7";this.promotionOpen=false;this.currentToken="";};window.Report.prototype={initUI:function(){var a=this;var b={list:"",adorder:"选择订单:",adslot:"选择广告位:",ad:"选择广告:",app:"选择应用:"};
if(a.param.name=="list"){$("div.sel_wrap,div.sel_title").hide();}if(b[a.param.name]){$("div.sel_title1").text(b[a.param.name]);}$(".sel_wrap").click(function(){$(this).find(".pop_menu").slideToggle(300,function(){$(".con",this).next().toggleClass("arrow_up");
});});$(".sel_wrap1").delegate("li","click",function(){$(".sel_wrap1 .con").text($(this).text()).attr("title",$(this).text()).attr("a_id",$(this).find("a").attr("id"));
a.currentToken=a.getToken();a.getPostData();a.loadData($(this).find("a").attr("id"),a.param.data);});if(a.param.name=="app"||a.param.name=="adslot"){$("div.sel_wrap2,div.sel_title2").show();
$(".sel_wrap2").delegate("li","click",function(){$(".sel_wrap2 .con").text($(this).text()).attr("title",$(this).text()).attr("category",$(this).find("a").attr("category"));
a.currentToken=a.getToken();a.getPostData();a.loadData($(".sel_wrap1 .con").attr("a_id"),a.param.data);});}$("div.panel_choicelnk a").not(".btn_choice_time").bind("click",function(){if($(this).hasClass("current")){return false;
}a.param.data.period=a.period=$(this).attr("period");$(".panel_choice_time").hide();if(a.period!="today"&&a.period!="yesterday"){$(".panel_chart").show();
}else{$(".panel_dashboard .item span").text("-");$(".panel_chart").hide();}a.currentToken=a.getToken();a.loadData(a.param.dataUrl=="/report/total"?"":$(".sel_wrap1 .con").attr("a_id"),a.param.data);
$(this).addClass("current").siblings().removeClass("current");return false;});$(".btn_choice_time").click(function(){$(this).addClass("current").siblings().removeClass("current");
$(this).parent().toggleClass("toggle_choice_time");$(".panel_choice_time").toggle();});$("#cus_start_time").datepicker({dateFormat:"yy-mm-dd",changeYear:true,changeMonth:true,monthNamesShort:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesMin:["日","一","二","三","四","五","六"]});
$("#cus_end_time").datepicker({dateFormat:"yy-mm-dd",changeYear:true,changeMonth:true,monthNamesShort:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesMin:["日","一","二","三","四","五","六"]});
$(".panel_choice_time button").click(function(){a.currentToken=a.getToken();a.getPostData();a.loadData(a.param.dataUrl=="/report/total"?"":$(".sel_wrap1 .con").attr("a_id"),a.param.data);
});},getToken:function(){return Math.random().toString(16).substring(2);},getPostData:function(){var a=this;delete a.param.data.period;delete a.param.data.startDate;
delete a.param.data.endDate;a.promotionOpen=false;delete a.param.data.category;a.param.data.category=$(".sel_wrap2 .con").attr("category");if($("div.panel_choicelnk a.current").index()<6){a.param.data.period=a.period;
}else{if($("#cus_start_time").val()!=""&&$("#cus_end_time").val()!=""){a.param.data.startDate=$("#cus_start_time").val();a.param.data.endDate=$("#cus_end_time").val();
}}if($(".sel_wrap2 .con").attr("category")=="0"){a.promotionOpen=true;}},tmplList:function(c){var b=this;if(this.param.listTmpl.length>0){$(this.param.listTmpl).tmpl(c).appendTo(this.param.listContainer);
var a=$(b.param.listContainer).find("li a").eq(0).text(),d=$(b.param.listContainer).find("li a").eq(0).attr("id");$(".sel_wrap1 span.con").text(a).attr("title",a).attr("a_id",d);
this.loadData($(b.param.listContainer).find("li a").eq(0).attr("id"));}},tmplData:function(a){if(this.param.dataTmpl.length>0){$(this.param.dataContainer).find("tr:gt(1)").remove();
if(this.promotionOpen){$("tr.normalReportTitle").hide();$("tr.promotionReportTitle").show().parent().addClass("promotionTable");$(this.param.dataPromotionTmpl).tmpl(a.reportList).appendTo(this.param.dataContainer);
if(this.period!="today"&&this.period!="yesterday"){this.drawGraph(a.reportList);}this.dashPromotionBoard(a.summary);}else{$("tr.normalReportTitle").show();
$("tr.promotionReportTitle").hide();$(this.param.dataTmpl).tmpl(a.reportList,{round:function(c){var b=c.toString().split(".")[1];if(b!=undefined&&b.length>2){return c.toFixed(2);
}else{return c;}}}).appendTo(this.param.dataContainer);if(this.period!="today"&&this.period!="yesterday"){this.drawGraph(a.reportList);}this.dashBoard(a.summary);
}}},loadList:function(){var a=this;a.param.data.rnd=Math.random();$.ajax({type:a.param.type,url:a.param.listUrl,data:a.param.data,beforeSend:function(){$(a.param.listContainer).find("li").remove().parents("div.sel_wrap").find("span.con").text("加载中！");
},success:function(b,c){if(b[a.param.resultInterface]!=undefined&&b[a.param.resultInterface].result.length>0){a.tmplList(b[a.param.resultInterface].result);
}else{$(".sel_wrap1 span.con").text("无记录!");$(a.param.dataContainer).find("tr:gt(1)").remove().end().append('<tr><td class="wait">没有记录！</td></tr>');}},complete:function(b,c){},error:function(){$(".sel_wrap1 span.con").text("加载失败！");
}});},loadData:function(d,c){var b=this;var a=b.currentToken;if(c==undefined){c={};}c.rnd=Math.random();$.ajax({type:b.param.type,url:b.param.dataUrl+(d!=undefined?("/"+d):""),data:c,beforeSend:function(){$(b.param.dataContainer).find("tr:gt(1)").remove().end().append('<tr><td class="wait">加载中请稍等！</td></tr>');
$("#chart1").text("加载中！");},success:function(e,f){if(a!=b.currentToken){return;}if(e.status=="failed"){$(b.param.dataContainer).find("td.wait").html("加载失败！");
$("#chart1").text("加载失败！");return false;}if(e.reportList!=null&&e.reportList.length>0){b.tmplData(e);}else{$(b.param.dataContainer).find("td.wait").html("没有记录！");
$("#chart1").text("无记录!");}},complete:function(e,f){},error:function(){$(b.param.dataContainer).find("td.wait").html("加载失败！");$("#chart1").text("加载失败！");
}});},dashBoard:function(f){$(".panel_dashboard2").hide();$(".panel_dashboard1").show();var b=$(".panel_dashboard1 .item span");try{var a=f.avgPrice.toString().split(".")[1],d=(f.clickRate*100).toString().split(".")[1],c=f.revenue.toString().split(".")[1];
b.eq(0).text("￥"+((a!=undefined&&a.length>2)?f.avgPrice.toFixed(2):f.avgPrice));b.eq(1).text(f.impression);b.eq(2).text(f.click);b.eq(3).text((d!=undefined&&d.length>2)?(f.clickRate*100).toFixed(2)+"%":(f.clickRate*100)+"%");
b.eq(4).text("￥"+((c!=undefined&&c.length>2)?f.revenue.toFixed(2):f.revenue));}catch(g){b.text("-");}},dashPromotionBoard:function(c){$(".panel_dashboard1").hide();
$(".panel_dashboard2").show();var a=$(".panel_dashboard2 .item span");try{var b=(c.clickRate*100).toString().split(".")[1];a.eq(0).text((b!=undefined&&b.length>2)?(c.clickRate*100).toFixed(2)+"%":(c.clickRate*100)+"%");
a.eq(1).text(c.click);a.eq(2).text(c.download);a.eq(3).text(c.promoterClick);a.eq(4).text(c.promoterDownload);}catch(d){a.text("-");}},drawGraph:function(d){var c=this;
c.chart={Chart:{},chart_id:"chart1",categories:[],step:2,series:[{name:"广告展示次数",data:[],type:null,visible:true},{name:"点击次数",data:[],type:null,visible:true},{name:"下载数",data:[],type:null,visible:true},{name:("收益"),data:[],type:null,visible:true}]};
$(c.chart.chart_id).text("");c.chart.step=parseInt(d.length/7);if(c.promotionOpen){c.chart.series=[{name:"贡献展示数",data:[],type:null,visible:true},{name:"获得展示数",data:[],type:null,visible:true},{name:"贡献点击量",data:[],type:null,visible:true},{name:"获得点击量",data:[],type:null,visible:true},{name:"贡献下载数",data:[],type:null,visible:true},{name:"获得下载数",data:[],type:null,visible:true},{name:"贡献点击率",data:[],type:null,visible:true},{name:"获得点击率",data:[],type:null,visible:true},];
for(var b=d.length-1;b>=0;b--){c.chart.categories.push(d[b].date);c.chart.series[0].data.push(d[b].impression);c.chart.series[1].data.push(d[b].promoterImpression);
c.chart.series[2].data.push(d[b].click);c.chart.series[3].data.push(d[b].promoterClick);c.chart.series[4].data.push(d[b].download);c.chart.series[5].data.push(d[b].promoterDownload);
c.chart.series[6].data.push(d[b].clickRate);c.chart.series[7].data.push(d[b].promoterClickRate);}}else{for(var b=d.length-1;b>=0;b--){c.chart.categories.push(d[b].date);
c.chart.series[0].data.push(d[b].impression);c.chart.series[1].data.push(d[b].click);c.chart.series[2].data.push(d[b].download);c.chart.series[3].data.push(d[b].revenue);
}}var a={chart:{defaultSeriesType:"spline",animation:false,renderTo:c.chart.chart_id},title:{text:$(".sel_wrap2 .con").text()},legend:{margin:15,enabled:true},xAxis:{categories:c.chart.categories,labels:{step:c.chart.step,align:"center",rotation:0}},yAxis:{title:"",min:0,tickPixelInterval:50},tooltip:{enabled:true},credits:{enabled:false},plotOptions:{area:{stacking:null}},series:c.chart.series,subtitle:{}};
a.tooltip.formatter=function(){var f="";f=this.series.name+"@"+this.x+": ";if(this.series.name=="收益"){var e=this.y.toString().split(".")[1];f+="￥"+((e!=undefined&&e.length>2)?this.y.toFixed(2):this.y);
}else{if(this.series.name.indexOf("点击率")>-1){var e=(this.y*100).toString().split(".")[1];f+=((e!=undefined&&e.length>2)?this.y.toFixed(2):this.y)+"%";}else{f+=this.y;
}}return f;};c.chart.Chart=new Highcharts.Chart(a);}};